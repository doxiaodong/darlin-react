worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size  5M;

    gzip  on;

    server {
        listen       4000;
        server_name  localhost;
        client_max_body_size  5M;

        #charset koi8-r;

        access_log  /var/log/nginx/access.log;

        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            try_files $uri @prerender;
        }

        location @prerender {
            #proxy_set_header X-Prerender-Token YOUR_TOKEN;

            set $prerender 0;
            if ($http_user_agent ~* "googlebot|yahoo|bingbot|baiduspider|yandex|yeti|yodaobot|gigabot|ia_archiver|facebookexternalhit|twitterbot|developers\.google\.com") {
                set $prerender 0;
            }
            if ($args ~ "_escaped_fragment_|prerender=1") {
                set $prerender 0;
            }
            if ($http_user_agent ~ "Prerender") {
                set $prerender 0;
            }

            if ($prerender = 1) {
                rewrite .* /$scheme://$host$request_uri? break;
                proxy_pass https://service.prerender.io;
            }
            if ($prerender = 0) {
                rewrite .* /index.html break;
            }
        }

    }

}
